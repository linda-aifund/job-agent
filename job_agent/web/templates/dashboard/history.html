{% extends "base.html" %}
{% block title %}Run History â€” Job Agent{% endblock %}

{% block content %}
<h1 style="margin-bottom: 8px;">Run History</h1>
<p style="color: var(--text-muted); font-size: 14px; margin-bottom: 16px;">
    {{ total }} runs &middot; Page {{ page }} of {{ total_pages }}
</p>

<div class="card" style="padding: 0;">
<div class="table-wrap">
<table>
    <thead>
        <tr>
            <th>Date</th>
            <th>Fetched</th>
            <th>New</th>
            <th>Matched</th>
            <th>Email Sent</th>
            <th>Duration</th>
            <th>Error</th>
        </tr>
    </thead>
    <tbody>
        {% for run in runs %}
        <tr>
            <td>{{ run.run_at.strftime('%Y-%m-%d %H:%M') }}</td>
            <td>{{ run.jobs_fetched }}</td>
            <td>{{ run.new_jobs_found }}</td>
            <td>{{ run.jobs_matched }}</td>
            <td>{{ 'Yes' if run.email_sent else 'No' }}</td>
            <td>{{ '%.1f' | format(run.duration_seconds) if run.duration_seconds else '-' }}s</td>
            <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;"
                title="{{ run.error_message or '' }}">
                {% if run.error_message %}
                <span style="color: var(--danger);">{{ run.error_message[:60] }}</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
        {% if not runs %}
        <tr>
            <td colspan="7" style="text-align:center; color:var(--text-muted); padding:24px;">No runs yet.</td>
        </tr>
        {% endif %}
    </tbody>
</table>
</div>
</div>

{% if total_pages > 1 %}
<div class="pagination">
    {% if page > 1 %}
    <a href="/dashboard/history?page={{ page - 1 }}">&laquo; Prev</a>
    {% endif %}
    {% for p in range(1, total_pages + 1) %}
        {% if p == page %}
        <span class="active">{{ p }}</span>
        {% elif p <= 3 or p > total_pages - 3 or (p >= page - 1 and p <= page + 1) %}
        <a href="/dashboard/history?page={{ p }}">{{ p }}</a>
        {% elif p == 4 or p == total_pages - 3 %}
        <span>&hellip;</span>
        {% endif %}
    {% endfor %}
    {% if page < total_pages %}
    <a href="/dashboard/history?page={{ page + 1 }}">Next &raquo;</a>
    {% endif %}
</div>
{% endif %}
{% endblock %}
